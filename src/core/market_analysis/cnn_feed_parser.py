"""
â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘
â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•       â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•

ðŸ”ï¸ ALGORITHMIC TRADING SYSTEM - "They delved too greedily and too deep..."

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“‹ MODULE: CNN Fear & Greed Index Parser                                      â”‚
â”‚ ðŸ“„ FILE: cnn_feed_parser.py                                                    â”‚
â”‚ ðŸ“… CREATED: 2024-12-21                                                             â”‚
â”‚ ðŸ‘‘ AUTHOR: FeanorKingofNoldor                                                      â”‚
â”‚ ðŸ”— REPOSITORY: https://github.com/FeanorKingofNoldor/khazad_dum                   â”‚
â”‚ ðŸ“§ CONTACT: [Your Contact Info]                                                    â”‚
â”‚                                                                                     â”‚
â”‚ ðŸŽ¯ PURPOSE:                                                                        â”‚
â”‚ Custom CNN Fear & Greed Index scraper (Python 3.13 compatible)                    â”‚
â”‚                                                                                     â”‚
â”‚ ðŸ”§ DEPENDENCIES:                                                                   â”‚
â”‚ - requests (HTTP client)                                                           â”‚
â”‚ - json (data parsing)                                                              â”‚
â”‚ - yfinance (VIX fallback)                                                          â”‚
â”‚                                                                                     â”‚
â”‚ ðŸ“ˆ TRADING PIPELINE STAGE: 1. Market Regime Detection                           â”‚
â”‚ â””â”€â”€ 1. Market Regime Detection â† YOU ARE HERE                                    â”‚
â”‚ â””â”€â”€ 2. Stock Screening                                                             â”‚
â”‚ â””â”€â”€ 3. AI Analysis (TradingAgents)                                                 â”‚
â”‚ â””â”€â”€ 4. Pattern Recognition                                                         â”‚
â”‚ â””â”€â”€ 5. Portfolio Construction                                                      â”‚
â”‚ â””â”€â”€ 6. Performance Observation                                                     â”‚
â”‚                                                                                     â”‚
â”‚ âš ï¸  CRITICAL NOTES:                                                                â”‚
â”‚ - Fallback to VIX-based regime when CNN API fails                                 â”‚
â”‚ - Browser-like headers to avoid blocking                                          â”‚
â”‚ - Robust error handling for network issues                                        â”‚
â”‚                                                                                     â”‚
â”‚ ðŸ“Š PERFORMANCE NOTES:                                                              â”‚
â”‚ - API call latency: ~500ms (network dependent)                                   â”‚
â”‚ - 10-second timeout to prevent hanging                                            â”‚
â”‚ - Automatic text label generation from numeric score                             â”‚
â”‚                                                                                     â”‚
â”‚ ðŸ§ª TESTING:                                                                        â”‚
â”‚ - Unit Tests: tests/unit/test_cnn_feed_parser.py                                  â”‚
â”‚ - Integration Tests: tests/integration/test_market_analysis_integration.py        â”‚
â”‚                                                                                     â”‚
â”‚ ðŸ“š DOCUMENTATION:                                                                  â”‚
â”‚ - API Docs: Auto-generated from docstrings                                        â”‚
â”‚ - Usage Guide: docs/guides/CNN_PARSER_USAGE.md                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Licensed under MIT License - See LICENSE file for details
Copyright (c) 2024 FeanorKingofNoldor

"In the depths of Khazad-dÃ»m, the markets reveal their secrets to those who dare..."
"""

import requests
import json
from typing import Dict


class CNNFeedParser:
    """
    Fetches CNN Fear & Greed Index without the broken package
    """
    
    def __init__(self):
        self.url = "https://production.dataviz.cnn.io/index/fearandgreed/graphdata"
        
    def get_fear_and_greed_index(self) -> Dict:
        """
        Fetch the Fear & Greed data from CNN
        """
        try:
            # Add headers to mimic a browser request
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'application/json, text/plain, */*',
                'Referer': 'https://www.cnn.com/',
            }
            
            response = requests.get(self.url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                
                # The API structure: data -> fear_and_greed -> score
                if 'fear_and_greed' in data:
                    fg_data = data['fear_and_greed']
                    current_value = fg_data.get('score', 50)
                    
                    # Debug print to see what we got
                    print(f"Successfully fetched CNN F&G: {current_value}")
                else:
                    # Print what keys we actually got
                    print(f"Unexpected API structure. Keys: {list(data.keys())}")
                    # Try direct score access
                    current_value = data.get('score', 50)
                
                # Convert to integer
                current_value = round(float(current_value))
                
                # Determine text label
                if current_value < 25:
                    text = "Extreme Fear"
                elif current_value < 45:
                    text = "Fear"
                elif current_value < 55:
                    text = "Neutral"
                elif current_value < 75:
                    text = "Greed"
                else:
                    text = "Extreme Greed"
                
                return {
                    'value': current_value,
                    'text': text
                }
            else:
                print(f"API returned status code: {response.status_code}")
                
        except requests.exceptions.RequestException as e:
            print(f"Network error: {e}")
        except json.JSONDecodeError as e:
            print(f"JSON parsing error: {e}")
        except Exception as e:
            print(f"Unexpected error: {e}")
        
        # Fallback based on VIX if we can't get CNN
        print("CNN API failed, using VIX-based estimate")
        try:
            import yfinance as yf
            vix = yf.Ticker("^VIX").info['regularMarketPrice']
            
            if vix < 15:
                return {'value': 65, 'text': 'Greed'}
            elif vix < 20:
                return {'value': 50, 'text': 'Neutral'}
            elif vix < 30:
                return {'value': 35, 'text': 'Fear'}
            else:
                return {'value': 15, 'text': 'Extreme Fear'}
        except:
            return {'value': 50, 'text': 'Neutral'}
    
    def get_complete_report(self):
        """Compatibility method"""
        data = self.get_fear_and_greed_index()
        return {'fear_greed': data}