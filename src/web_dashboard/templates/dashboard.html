<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è Khazad-d√ªm Trading Dashboard</title>
    
    <!-- Mobile-first responsive CSS -->
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-blue: #3366ff;
            --accent-gold: #ffd700;
            --border-color: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 20px 10px;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--accent-gold);
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--accent-gold);
            text-shadow: 0 0 10px var(--accent-gold);
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 5px;
        }
        
        .status-healthy { background: var(--accent-green); color: black; }
        .status-degraded { background: #ff9500; color: black; }
        .status-unhealthy { background: var(--accent-red); color: white; }
        
        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .container {
                max-width: 1200px;
            }
        }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        /* Metrics */
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .metric-positive { color: var(--accent-green); }
        .metric-negative { color: var(--accent-red); }
        .metric-neutral { color: var(--text-primary); }
        
        /* Position List */
        .position-list, .signal-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .position-item, .signal-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            margin: 8px 0;
            font-size: 0.9rem;
        }
        
        .position-symbol, .signal-symbol {
            font-weight: bold;
            color: var(--accent-blue);
            font-size: 1.1rem;
        }
        
        .position-details, .signal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        @media (max-width: 480px) {
            .position-details, .signal-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading states */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { color: rgba(255, 255, 255, 0); text-shadow: .25em 0 0 rgba(255, 255, 255, 0), .5em 0 0 rgba(255, 255, 255, 0); }
            40% { color: white; text-shadow: .25em 0 0 rgba(255, 255, 255, 0), .5em 0 0 rgba(255, 255, 255, 0); }
            60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(255, 255, 255, 0); }
            80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; }
        }
        
        /* Connection status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            z-index: 1000;
        }
        
        .connected { background: var(--accent-green); color: black; }
        .disconnected { background: var(--accent-red); color: white; }
        
        /* Last updated */
        .last-updated {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin: 20px 0;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .header h1 { font-size: 1.5rem; }
            .card { padding: 15px; }
            .card-title { font-size: 1rem; }
            .metric { font-size: 0.85rem; }
            .container { padding: 5px; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        üîå Connecting...
    </div>
    
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Khazad-d√ªm Trading System</h1>
            <div id="systemStatus">
                <div class="status-indicator loading">Loading system status</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- Trading Summary Card -->
            <div class="card">
                <div class="card-title">üí∞ Trading Summary</div>
                <div id="tradingSummary">
                    <div class="loading">Loading trading data</div>
                </div>
            </div>
            
            <!-- System Health Card -->
            <div class="card">
                <div class="card-title">üè• System Health</div>
                <div id="systemHealth">
                    <div class="loading">Checking system health</div>
                </div>
            </div>
            
            <!-- Active Positions Card -->
            <div class="card">
                <div class="card-title">üìä Active Positions</div>
                <div id="activePositions">
                    <div class="loading">Loading positions</div>
                </div>
            </div>
        </div>
        
        <!-- Full-width Recent Signals -->
        <div class="card">
            <div class="card-title">üéØ Recent Trading Signals</div>
            <div id="recentSignals">
                <div class="loading">Loading recent signals</div>
            </div>
        </div>
        
        <div class="last-updated" id="lastUpdated">
            Last updated: Never
        </div>
    </div>

    <script>
        class TradingDashboard {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
                
                this.initializeWebSocket();
                this.loadInitialData();
                
                // Reload page if hidden for more than 5 minutes (mobile battery optimization)
                document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));
            }
            
            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        this.updateConnectionStatus(true);
                        this.reconnectAttempts = 0;
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleUpdate(data);
                    };
                    
                    this.ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.updateConnectionStatus(false);
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus(false);
                    };
                    
                } catch (error) {
                    console.error('Failed to create WebSocket:', error);
                    this.updateConnectionStatus(false);
                }
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    setTimeout(() => {
                        console.log(`Reconnection attempt ${this.reconnectAttempts + 1}`);
                        this.reconnectAttempts++;
                        this.initializeWebSocket();
                    }, this.reconnectDelay * (this.reconnectAttempts + 1));
                }
            }
            
            updateConnectionStatus(connected) {
                const status = document.getElementById('connectionStatus');
                if (connected) {
                    status.className = 'connection-status connected';
                    status.textContent = 'üü¢ Connected';
                } else {
                    status.className = 'connection-status disconnected';
                    status.textContent = 'üî¥ Disconnected';
                }
            }
            
            async loadInitialData() {
                try {
                    const [health, trading, positions, signals] = await Promise.all([
                        fetch('/api/health').then(r => r.json()),
                        fetch('/api/trading-summary').then(r => r.json()),
                        fetch('/api/positions').then(r => r.json()),
                        fetch('/api/signals').then(r => r.json())
                    ]);
                    
                    this.updateHealth(health);
                    this.updateTradingSummary(trading);
                    this.updatePositions(positions);
                    this.updateSignals(signals);
                    this.updateLastUpdated();
                    
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                }
            }
            
            handleUpdate(data) {
                if (data.type === 'dashboard_update' && data.data) {
                    const { health, trading, positions, signals } = data.data;
                    
                    if (health) this.updateHealth(health);
                    if (trading) this.updateTradingSummary(trading);
                    if (positions) this.updatePositions(positions);
                    if (signals) this.updateSignals(signals);
                    
                    this.updateLastUpdated();
                }
            }
            
            updateHealth(health) {
                const statusDiv = document.getElementById('systemStatus');
                const healthDiv = document.getElementById('systemHealth');
                
                // Overall status
                const statusClass = `status-${health.status}`;
                statusDiv.innerHTML = `<div class="status-indicator ${statusClass}">${health.status.toUpperCase()}</div>`;
                
                // Detailed health info
                let healthHtml = '';
                if (health.services) {
                    Object.entries(health.services).forEach(([service, info]) => {
                        const statusIcon = info.status === 'healthy' ? 'üü¢' : 
                                         info.status === 'degraded' ? 'üü°' : 'üî¥';
                        healthHtml += `
                            <div class="metric">
                                <span class="metric-label">${statusIcon} ${service.replace('_', ' ')}</span>
                                <span class="metric-value metric-${info.status === 'healthy' ? 'positive' : 'negative'}">
                                    ${Math.round(info.latency_ms)}ms
                                </span>
                            </div>
                        `;
                    });
                }
                healthDiv.innerHTML = healthHtml || '<div class="loading">No health data available</div>';
            }
            
            updateTradingSummary(trading) {
                const tradingDiv = document.getElementById('tradingSummary');
                
                const formatCurrency = (value) => `$${value.toLocaleString()}`;
                const formatPercent = (value) => `${value.toFixed(1)}%`;
                
                tradingDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Open Positions</span>
                        <span class="metric-value metric-neutral">${trading.open_positions}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Value</span>
                        <span class="metric-value metric-neutral">${formatCurrency(trading.open_value)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total P&L</span>
                        <span class="metric-value ${trading.total_pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${formatCurrency(trading.total_pnl)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Win Rate (7d)</span>
                        <span class="metric-value ${trading.win_rate >= 60 ? 'metric-positive' : 'metric-neutral'}">
                            ${formatPercent(trading.win_rate)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Return (7d)</span>
                        <span class="metric-value ${trading.avg_return >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${formatPercent(trading.avg_return)}
                        </span>
                    </div>
                `;
            }
            
            updatePositions(positions) {
                const positionsDiv = document.getElementById('activePositions');
                
                if (!positions || positions.length === 0) {
                    positionsDiv.innerHTML = '<div class="metric-label">No active positions</div>';
                    return;
                }
                
                const positionsHtml = positions.map(pos => {
                    const pnl = ((pos.current_price || pos.entry_price) - pos.entry_price) / pos.entry_price * 100;
                    return `
                        <div class="position-item">
                            <div class="position-symbol">${pos.symbol}</div>
                            <div class="position-details">
                                <div>Entry: $${pos.entry_price.toFixed(2)}</div>
                                <div>Size: $${pos.position_size.toLocaleString()}</div>
                                <div>Stop: $${pos.stop_loss.toFixed(2)}</div>
                                <div>Days: ${pos.days_held}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                positionsDiv.innerHTML = `<div class="position-list">${positionsHtml}</div>`;
            }
            
            updateSignals(signals) {
                const signalsDiv = document.getElementById('recentSignals');
                
                if (!signals || signals.length === 0) {
                    signalsDiv.innerHTML = '<div class="metric-label">No recent signals</div>';
                    return;
                }
                
                const signalsHtml = signals.map(signal => {
                    const decisionIcon = signal.decision === 'BUY' ? 'üìà' : 
                                       signal.decision === 'SELL' ? 'üìâ' : '‚ö™';
                    const decisionClass = signal.decision === 'BUY' ? 'metric-positive' : 
                                        signal.decision === 'SELL' ? 'metric-negative' : 'metric-neutral';
                    
                    return `
                        <div class="signal-item">
                            <div class="signal-symbol">${decisionIcon} ${signal.symbol}</div>
                            <div class="signal-details">
                                <div class="${decisionClass}">${signal.decision}</div>
                                <div>Conviction: ${(signal.conviction * 100).toFixed(0)}%</div>
                                <div>Price: $${signal.entry_price.toFixed(2)}</div>
                                <div>Regime: ${signal.regime}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                signalsDiv.innerHTML = `<div class="signal-list">${signalsHtml}</div>`;
            }
            
            updateLastUpdated() {
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
            }
            
            handleVisibilityChange() {
                if (document.hidden) {
                    this.hideTime = Date.now();
                } else if (this.hideTime && Date.now() - this.hideTime > 300000) { // 5 minutes
                    location.reload();
                }
            }
        }
        
        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new TradingDashboard();
        });
    </script>
</body>
</html>